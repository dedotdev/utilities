name: chain-specs-periodic-update

on:
  schedule:
    - cron: '0 8 * * *' # every day at 8am
  workflow_dispatch: # allow manual trigger from the UI

permissions:
  contents: write # allow pushing commits and branches
  pull-requests: write # allow creating or updating pull requests
  issues: write # allow creating issues on failure

jobs:
  download-spec:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        rpc-node-address:
          [
            'wss://rpc.polkadot.io',
            'wss://kusama-rpc.polkadot.io',
            'wss://westend-rpc.polkadot.io',
            'wss://rococo-rpc.polkadot.io',
            'wss://rpc.dotters.network/paseo',
          ]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
          path: repo
          ref: main

      - name: Install websocat
        run: |
          curl -L -O https://github.com/vi/websocat/releases/download/v1.9.0/websocat_linux64
          chmod +x websocat_linux64

      - name: Download chain spec
        run: |
          echo '{"id":1,"jsonrpc":"2.0","method":"sync_state_genSyncSpec","params":[true]}' \
            | ./websocat_linux64 -n1 -B 99999999 ${{ matrix.rpc-node-address }} > rpc_answer.json

      - name: Extract chain spec result
        run: cat ./rpc_answer.json | jq .result > chain_spec.json

      - name: Get chain ID
        id: get-chain-id
        run: echo "id=$(jq -r .id ./chain_spec.json)" >> $GITHUB_OUTPUT

      - name: Upload failed response
        if: ${{ steps.get-chain-id.outputs.id == '' }}
        uses: actions/upload-artifact@v4
        with:
          name: failed-response-${{ github.run_id }}
          path: rpc_answer.json

      - name: Update chain spec file
        if: ${{ steps.get-chain-id.outputs.id != '' }}
        run: |
          tmp=$(mktemp)
          output="./repo/packages/connect-known-chains/specs/${{ steps.get-chain-id.outputs.id }}.json"
          jq --slurpfile downloaded ./chain_spec.json \
            '.lightSyncState = $downloaded[0].lightSyncState' "$output" > "$tmp"
          mv "$tmp" "$output"

      - name: Upload updated chain spec
        uses: actions/upload-artifact@v4
        with:
          name: chain-spec-${{ steps.get-chain-id.outputs.id }}
          path: repo/**/${{ steps.get-chain-id.outputs.id }}.json

  create-pr:
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs: download-spec

    steps:
      - uses: actions/checkout@v4
        with:
          path: repo
          ref: main

      - uses: actions/download-artifact@v4
        with:
          path: .

      - name: Copy updated specs
        run: |
          cp -r ./chain-spec-*/* ./repo

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          committer: debot <hi@coongcrafts.io>
          author: debot <hi@coongcrafts.io>
          path: repo
          branch: automatic-checkpoints-update
          base: main
          title: 'chore: update chain specifications'
          body: |
            This pull request has been automatically generated by downloading chain
            specifications from various JSON-RPC endpoints and extracting their checkpoints.

            ⚠️ Keep in mind that introducing a malicious checkpoint can redirect users to the wrong chain.
            If this pull request looks suspicious, please be cautious.
          commit-message: 'chore: update checkpoints in chain specifications'
          delete-branch: true

      - name: Verify PR creation
        if: ${{ steps.create-pr.outcome != 'success' }}
        run: |
          echo "Failed to create pull request"
          exit 1

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Failed to create pull request for updating chain specifications',
              body: 'The create-pr step failed in the chain-specs-periodic-update workflow. Please investigate the issue.',
              labels: ['bug']
            })
